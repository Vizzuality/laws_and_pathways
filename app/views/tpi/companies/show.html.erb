<% content_for :page_title, "#{@company.name} - Transition Pathway Initiative" %>
<% content_for :page_description, "Assess how prepared #{@company.name} is for the transition to a low-carbon economy â€“ its Management Quality and Carbon Performance." %>

<% regional_view = @company.cp_alignment_region.present? && params[:view] == 'regional' %>

<div class="company-page" data-controller="companies">
  <div class="dropdown-selector-company-page-wrapper">
    <%= react_component("DropdownSelector", { sectors: @sectors, companies: @companies, selectedOption: @company.name, defaultFilter: 'company' }) %>
  </div>
  <div class="companies-header">
    <div class="container is-hidden-touch">
      <div class="mq-beta-scores">
        <div class="mq-beta-scores__download-button">
          <%= button_to user_download_methodology_tpi_sectors_path, class: 'button is-primary is-pulled-right with-icon with-border', method: :get do %>
            <img src="<%= asset_path 'icons/download.svg'%>" alt="download icon" />
            Methodology
          <% end %>
          <%= react_component('DownloadFormModal', {
            title: 'Explore CP data access',
            buttonClass: 'button is-primary with-icon with-border',
            downloadUrl: user_download_cp_all_tpi_sectors_path,
            source: 'cp',
            showIcon: true
          }) %>
          <%= react_component('DownloadFormModal', {
            title: 'Explore MQ data access',
            buttonClass: 'button is-primary with-icon with-border',
            downloadUrl: user_download_mq_all_tpi_sectors_path,
            source: 'mq',
            showIcon: true
          }) %>
        </div>
      </div>
    </div>
    <div class="container is-hidden-desktop">
      <div class="mq-beta-scores is-hidden-desktop">
        <%= render 'tpi/shared/mq_beta_scores', has_data: @company.beta_mq_assessments? %>
      </div>
    </div>
  </div>

  <% if @company.cp_alignment_region.present? %>
    <section class="container change-view">
      <div class="buttons has-addons">
        <%= link_to "Global benchmarks", {view: nil}, class: "button #{!regional_view ? 'is-primary' : 'is-secondary'}" %>
        <%= link_to "Regional benchmarks", {view: 'regional'}, class: "button #{regional_view ? 'is-primary' : 'is-secondary'}" %>
      </div>
      <div class="has-text-right">
        <% if regional_view %>
          The regional benchmarks applied to this company are for <%= @company.cp_alignment_region %>.
        <% end %>
      </div>
    </section>
  <% end %>

  <section class="container summary-boxes">
    <div class="columns">
      <div class="column">
        <a href="#management-quality" class="summary-box-link">
          <div class="summary-box summary-box--assessment">
            <h4>Management Quality</h4>
            <p>
              <small>Number of assessments: <%= hide_mq_assessments_with_same_date(@company_presenter.mq_assessments).size %></small>
            </p>
            <% if @company_presenter.mq_assessments.any? %>
              <%= render 'mq_level', level: @company.mq_level, status: @company.mq_status %>
              <p>
                <%= t("tpi.company.level_description.#{@company.mq_level.to_i}") %></h3>
              </p>
            <% end %>
          </div>
        </a>
      </div>
      <div class="column is-three-fifths">
        <a href="#carbon-performance" class="summary-box-link">
          <div class="summary-box summary-box--assessment">
            <h4>Carbon Performance</h4>
            <p>
              <small>Number of assessments: <%= @company_presenter.cp_assessments.size %></small>
            </p>

            <% @company_presenter.graph_cp_assessments.each do |assessment| %>
              <% subsector = assessment.company_subsector %>
              <% if subsector.present? %>
                <h4 class="subsector"><%= subsector.subsector %></h4>
              <% end %>
              <% long_term_header = "Long-term<br/> alignment in #{@company.sector.name.downcase == 'electricity utilities' ? '2040-50' : '2050'}" %>
              <% unless regional_view %>
                <div class="cp-alignments">
                  <% if assessment.cp_alignment_2028.present? %>
                    <%= render 'cp_alignment', header: 'Short-term<br/> alignment in 2028', alignment: assessment.cp_alignment_2028_by_company %>
                  <% else %>
                    <%= render 'cp_alignment', header: 'Short-term<br/> alignment in 2027', alignment: assessment.cp_alignment_2027_by_company %>
                  <% end %>
                  <%= render 'cp_alignment', header: 'Medium-term<br/> alignment in 2035', alignment: assessment.cp_alignment_2035_by_company %>
                  <%= render 'cp_alignment', header: long_term_header, alignment: assessment.cp_alignment_2050_by_company %>
                </div>
              <% else %>
                <div class="cp-alignments">
                  <% if @company_presenter.cp_regional_alignment_2028.present? %>
                    <%= render 'cp_alignment', header: 'Short-term<br/> alignment in 2028', alignment: assessment.cp_regional_alignment_2028_by_company %>
                  <% else %>
                    <%= render 'cp_alignment', header: 'Short-term<br/> alignment in 2027', alignment: assessment.cp_regional_alignment_2027_by_company %>
                  <% end %>
                  <%= render 'cp_alignment', header: 'Medium-term<br/> alignment in 2035', alignment: assessment.cp_regional_alignment_2035_by_company %>
                  <%= render 'cp_alignment', header: long_term_header, alignment: assessment.cp_regional_alignment_2050_by_company %>
                </div>
              <% end %>

            <% end %>
          </div>
        </a>
      </div>
    </div>
    <div class="columns">
      <div class="column">
        <div class="summary-box">
          <div class="columns">
            <div class="column">
              <%= render 'tpi/shared/property', highlight: false, name: 'Geography', tooltip: t('tpi.tooltips.geography') do %>
                <%= @company.geography.name %>
              <% end %>
            </div>
            <% if @company.sector.industries.any? %>
              <div class="column">
                <%= render 'tpi/shared/property', highlight: true, name: 'Industry' do %>
                  <%= safe_join(@company.sector.industries.order(:name).map { |i| link_to(i.name, tpi_corporate_industry_path(i.slug)) }, ', ') %>
                <% end %>
              </div>
            <% end %>
            <div class="column">
              <%= render 'tpi/shared/property', highlight: true, name: 'Sector' do %>
                <%= link_to @company.sector.name, tpi_sector_path(@company.sector.slug) %>
              <% end %>
            </div>
            <div class="column">
              <%= render 'tpi/shared/property', highlight: false, name: 'Market cap (Group)', tooltip: t('tpi.tooltips.market_cap') do %>
                <%= @company.market_cap_group %>
              <% end %>
            </div>
            <div class="column">
              <%= render 'tpi/shared/property', highlight: false, name: 'ISIN', tooltip: t('tpi.tooltips.ISIN') do %>
                <%= @company.isin_array.join('<br/>').html_safe %>
              <% end %>
            </div>
            <div class="column">
              <%= render 'tpi/shared/property', highlight: false, name: 'SEDOL', tooltip: t('tpi.tooltips.SEDOL') do %>
                <%= @company.sedol %>
              <% end %>
            </div>
            <div class="column">
              <%= render 'tpi/shared/property', highlight: false, name: 'CA100+ engagement', tooltip: t('tpi.tooltips.CA100') do %>
                <%= humanize_boolean(@company.ca100?) %>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <% if @company_presenter.mq_assessments.any? %>
    <section id="management-quality" class="management-quality container">
      <div class="management-quality__header">
        <h4>
          Management Quality: <%= @company.name %>
        </h4>

        <div class="is-hidden-touch show-by-dropdown assessment-date__container">
          <div class="caption">
            Publication Date:
          </div>
          <div class="date-dropdown">
            <%= react_component('RemoteDropdown', {
              name: 'mq_assessment_id',
              remote: true,
              url: mq_assessment_tpi_company_path(@company),
              data: hide_mq_assessments_with_same_date(@company_presenter.mq_assessments).map {|v| {label: v['publication_date']&.strftime('%d %B %Y'), value: v['id']}},
              selected: params[:mq_assessment_id]
            }) %>
          </div>
        </div>
      </div>
      <p>
        Assessment of <%= @company.name %> according to the management of its greenhouse gas emissions and of risks and opportunities related to the low-carbon transition.
      </p>
      <div class="is-hidden-desktop assessment-date__container">
        <div class="caption">
          Publication Date:
        </div>
        <div class="date-dropdown">
          <%= react_component('RemoteDropdown', {
            name: 'mq_assessment_id',
            remote: true,
            url: mq_assessment_tpi_company_path(@company),
            data: @company_presenter.mq_assessments.map {|v| {label: v['publication_date']&.strftime('%d %B %Y'), value: v['id']}},
            selected: params[:mq_assessment_id]
          }) %>
        </div>
      </div>

      <div id="mq-assessment-metadata" class="mq-assessment-metadata">
        <%= render partial: 'mq_assessment_metadata', locals: { assessment: @mq_assessment } %>
      </div>

      <div id="mq-assessment" class="management-quality__content">

        <%= render partial: 'mq_assessment', locals: { assessment: @mq_assessment } if @mq_assessment.present? %>
      </div>
    </section>
  <% end %>

  <% if @company_presenter.cp_assessments.any? %>
    <section id="carbon-performance" class="carbon-performance container">
      <div class="management-quality__header">
        <h4>
          Carbon Performance <%= @company.name %>
        </h4>
        <p class="is-hidden-desktop"><%= "Carbon Performance alignment of companies in the #{@company.name} sector with the Paris agreement benchmarks." %></p>

        <div>
          <div class="show-by-dropdown assessment-date__container">
            <div class="caption">
              Assessment Date:
            </div>

            <div class="date-dropdown">
              <%= react_component('RemoteDropdown', {
                name: 'cp_assessment_id',
                remote: true,
                url: cp_assessment_tpi_company_path(@company),
                params: regional_view ? "view=regional" : nil,
                data: @company_presenter.cp_assessments.map do |v|
                  label = v['assessment_date']&.strftime('%d %B %Y')
                  label += " (#{v['assessment_date_flag']})" if v['assessment_date_flag'].present?
                  label += " (#{v.subsector})" if v.subsector
                  {label: label, value: v['id']}
                end,
                selected: params[:cp_assessment_id]
              }) %>
            </div>
          </div>
        </div>
      </div>

      <div id="cp-assessment">
        <%= render partial: 'cp_assessment', locals: { assessment: @cp_assessment } %>
      </div>
    </section>
  <% end %>

  <% if @company.latest_information.present? %>
    <%= react_component("LatestInformation", { name: @company.name, latestInformation: @company.latest_information }) %>
  <% end %>
</div>
